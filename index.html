<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <meta name="theme-color" content="#3b82f6">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <title>Controle de Chegada</title>
    <link rel="manifest" href="manifest.json">
    <link rel="apple-touch-icon" href="icon.png">
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap');
        
        body {
            font-family: 'Inter', sans-serif;
            -webkit-tap-highlight-color: transparent;
            max-width: 100vw;
            overflow-x: hidden;
            touch-action: manipulation;
            background-color: #f8fafc;
        }
        
        .number-bubble {
            transition: all 0.2s ease;
            width: 2.5rem;
            height: 2.5rem;
            flex-shrink: 0;
        }
        
        .locked {
            opacity: 0.7;
        }
        
        .locked .delete-distance-btn,
        .locked .delete-category-btn,
        .locked .add-category-btn,
        .locked input {
            pointer-events: none;
            opacity: 0.7;
        }
        
        .locked .number-bubble {
            pointer-events: auto !important;
            opacity: 1 !important;
        }
        
        .scrollable-container {
            scrollbar-width: none;
        }
        
        .scrollable-container::-webkit-scrollbar {
            display: none;
        }
        
        input[type="text"], input[type="number"] {
            font-size: 0.9rem;
        }
        
        .winner-row {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            width: 100%;
            cursor: move;
        }
        
        .number-input {
            width: 5.5rem;
            flex-shrink: 0;
        }
        
        .name-input {
            flex-grow: 1;
            min-width: 0;
        }
        
        .fade-in {
            animation: fadeIn 0.3s ease-in-out;
        }
        
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        
        .slide-in {
            animation: slideIn 0.3s ease-out;
        }
        
        @keyframes slideIn {
            from { transform: translateX(100%); }
            to { transform: translateX(0); }
        }
        
        .dragging {
            opacity: 0.5;
            background-color: #e2e8f0;
        }
        
        .dropzone {
            border: 2px dashed #cbd5e1;
            background-color: #f8fafc;
        }
        
        .drop-target {
            border: 2px dashed #3b82f6;
            background-color: #eff6ff;
        }
        
        /* Custom scrollbar for table */
        .table-container {
            overflow-x: auto;
        }
        
        .table-container::-webkit-scrollbar {
            height: 6px;
        }
        
        .table-container::-webkit-scrollbar-track {
            background: #f1f1f1;
            border-radius: 10px;
        }
        
        .table-container::-webkit-scrollbar-thumb {
            background: #c1c1c1;
            border-radius: 10px;
        }
        
        .table-container::-webkit-scrollbar-thumb:hover {
            background: #a8a8a8;
        }
        
        /* Detail modal styles */
        .detail-modal {
            transition: all 0.3s ease;
        }
        
        .detail-modal-content {
            max-height: 80vh;
            overflow-y: auto;
        }
        
        /* Time input styles */
        .time-input-container {
            display: flex;
            gap: 0.5rem;
            align-items: center;
        }
        
        .time-input {
            width: 4rem;
            text-align: center;
        }
        
        .time-separator {
            font-weight: bold;
            color: #6b7280;
        }
        
        /* Distance buttons */
        .distance-btn {
            flex: 1 1 0;
            padding: 0.5rem;
            border-radius: 0.5rem;
            background-color: #e5e7eb;
            text-align: center;
            cursor: pointer;
            transition: all 0.2s ease;
        }
        
        .distance-btn:hover {
            background-color: #d1d5db;
        }
        
        .distance-btn.active {
            background-color: #3b82f6;
            color: white;
        }
        
        @media (max-width: 640px) {
            .responsive-text {
                font-size: 0.85rem;
            }
            
            .input-field {
                padding: 0.35rem 0.5rem;
                font-size: 0.85rem;
            }
            
            .number-bubble {
                width: 2.2rem;
                height: 2.2rem;
                font-size: 0.9rem;
            }
            
            .number-input {
                width: 4.8rem;
            }
            
            .modal-container {
                width: 95%;
                margin: 0 auto;
            }
            
            .detail-modal {
                width: 95%;
            }
            
            .time-input {
                width: 3.5rem;
            }
            
            .distance-btn {
                font-size: 0.8rem;
                padding: 0.4rem;
            }
        }
    </style>
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        primary: '#3b82f6',
                        secondary: '#10b981',
                        danger: '#ef4444',
                        warning: '#f59e0b',
                        dark: '#1e293b',
                        light: '#f8fafc'
                    }
                }
            }
        }
    </script>
</head>
<body class="bg-gray-50 min-h-screen">
    <div class="container mx-auto px-4 py-6 max-w-3xl">
        <!-- Header -->
        <div class="flex justify-between items-center mb-6">
            <div>
                <h1 class="text-2xl font-bold text-gray-800">Controle de Chegada</h1>
                <p class="text-sm text-gray-500">Registro de resultados de corrida</p>
            </div>
            <div class="flex items-center gap-2">
                <button id="helpBtn" class="p-2 rounded-full bg-white shadow text-gray-600 hover:bg-gray-100 transition">
                    <i class="fas fa-question-circle"></i>
                </button>
                <button id="lockBtn" class="p-2 rounded-full bg-white shadow text-gray-600 hover:bg-gray-100 transition">
                    <i class="fas fa-lock"></i>
                </button>
            </div>
        </div>
        
        <!-- Event Name -->
        <div class="bg-white rounded-xl shadow-md p-4 mb-6 border border-gray-100">
            <label for="eventName" class="block text-sm font-medium text-gray-700 mb-2">Nome do Evento</label>
            <input type="text" id="eventName" placeholder="Ex: Corrida da Cidade 2023" 
                   class="w-full px-4 py-2 border border-gray-200 rounded-lg focus:outline-none focus:ring-2 focus:ring-primary focus:border-transparent transition">
        </div>
        
        <!-- Controls -->
        <div class="grid grid-cols-2 gap-3 mb-6">
            <button id="addDistanceBtn" class="col-span-2 md:col-span-1 bg-primary hover:bg-blue-700 text-white py-2 px-4 rounded-lg transition flex items-center justify-center gap-2 shadow-md">
                <i class="fas fa-plus"></i> Adicionar Distância
            </button>
            <button id="clearAllBtn" class="col-span-2 md:col-span-1 bg-danger hover:bg-red-700 text-white py-2 px-4 rounded-lg transition flex items-center justify-center gap-2 shadow-md">
                <i class="fas fa-trash-alt"></i> Limpar Tudo
            </button>
            <button id="importBtn" class="bg-secondary hover:bg-green-700 text-white py-2 px-4 rounded-lg transition flex items-center justify-center gap-2 shadow-md">
                <i class="fas fa-file-import"></i> Importar
            </button>
            <button id="exportBtn" class="bg-purple-600 hover:bg-purple-700 text-white py-2 px-4 rounded-lg transition flex items-center justify-center gap-2 shadow-md">
                <i class="fas fa-file-export"></i> Exportar
            </button>
            <button id="paceCalculatorBtn" class="col-span-2 bg-amber-500 hover:bg-amber-600 text-white py-2 px-4 rounded-lg transition flex items-center justify-center gap-2 shadow-md">
                <i class="fas fa-calculator"></i> Calculadora de Pace
            </button>
        </div>
        
        <input type="file" id="importFile" accept=".csv,.xlsx" class="hidden">
        
        <!-- Search -->
        <div class="bg-white rounded-xl shadow-md p-4 mb-6 border border-gray-100">
            <div class="flex items-center gap-2 mb-2">
                <label for="searchInput" class="block text-sm font-medium text-gray-700">Buscar</label>
                <span class="text-xs text-gray-400">(Apenas nos dados importados)</span>
            </div>
            <div class="relative">
                <input type="text" id="searchInput" placeholder="Digite para buscar nos dados importados..." 
                       class="w-full px-4 py-2 border border-gray-200 rounded-lg focus:outline-none focus:ring-2 focus:ring-primary focus:border-transparent transition pr-10">
                <i class="fas fa-search absolute right-3 top-3 text-gray-400"></i>
                <button id="clearSearchBtn" class="absolute right-8 top-3 text-gray-400 hover:text-gray-600 hidden">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            <div id="importResults" class="mt-3 hidden max-h-60 overflow-y-auto scrollable-container border-t pt-3 rounded-lg bg-gray-50"></div>
        </div>
        
        <!-- Distances Container -->
        <div id="distancesContainer" class="space-y-4"></div>
        
        <!-- Empty State -->
        <div id="emptyState" class="text-center py-12 bg-white rounded-xl shadow-sm border border-dashed border-gray-200">
            <div class="mx-auto w-16 h-16 bg-blue-50 rounded-full flex items-center justify-center mb-4">
                <i class="fas fa-flag-checkered text-2xl text-primary"></i>
            </div>
            <h3 class="text-lg font-medium text-gray-700 mb-1">Nenhuma distância adicionada</h3>
            <p class="text-gray-500 mb-6">Comece adicionando uma distância para registrar os resultados</p>
            <button id="addFirstDistanceBtn" class="bg-primary hover:bg-blue-700 text-white py-2 px-6 rounded-lg transition inline-flex items-center gap-2 shadow-md">
                <i class="fas fa-plus"></i> Adicionar Distância
            </button>
        </div>
    </div>
    
    <!-- Add Distance Modal -->
    <div id="distanceModal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4 z-50 hidden">
        <div class="bg-white rounded-xl shadow-xl w-full max-w-md modal-container slide-in">
            <div class="p-5 border-b border-gray-100">
                <h3 class="text-lg font-semibold text-gray-900">Adicionar Distância</h3>
            </div>
            <div class="p-5">
                <label for="distanceName" class="block text-sm font-medium text-gray-700 mb-2">Nome da Distância</label>
                <input type="text" id="distanceName" placeholder="Ex: 5km, 10km, Meia Maratona" 
                       class="w-full px-4 py-2 border border-gray-200 rounded-lg focus:outline-none focus:ring-2 focus:ring-primary focus:border-transparent transition mb-5">
                <div class="flex justify-between gap-3">
                    <button id="cancelDistanceBtn" class="px-4 py-2 border border-gray-300 rounded-lg text-gray-700 hover:bg-gray-50 transition">Cancelar</button>
                    <div class="flex gap-3">
                        <button id="saveAndAddMoreDistanceBtn" class="px-4 py-2 bg-gray-200 text-gray-700 rounded-lg hover:bg-gray-300 transition shadow-md">
                            Salvar e Adicionar Outra
                        </button>
                        <button id="saveDistanceBtn" class="px-4 py-2 bg-primary text-white rounded-lg hover:bg-blue-700 transition shadow-md">Salvar</button>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Add Category Modal -->
    <div id="categoryModal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4 z-50 hidden">
        <div class="bg-white rounded-xl shadow-xl w-full max-w-md modal-container slide-in">
            <div class="p-5 border-b border-gray-100">
                <h3 class="text-lg font-semibold text-gray-900">Adicionar Categoria</h3>
            </div>
            <div class="p-5">
                <label for="categoryName" class="block text-sm font-medium text-gray-700 mb-2">Nome da Categoria</label>
                <input type="text" id="categoryName" placeholder="Ex: Masculino 18-30, Feminino 30+" 
                       class="w-full px-4 py-2 border border-gray-200 rounded-lg focus:outline-none focus:ring-2 focus:ring-primary focus:border-transparent transition mb-4">
                
                <label for="winnersCount" class="block text-sm font-medium text-gray-700 mb-2">Quantidade de Premiados</label>
                <input type="number" id="winnersCount" min="1" max="20" value="3" 
                       class="w-full px-4 py-2 border border-gray-200 rounded-lg focus:outline-none focus:ring-2 focus:ring-primary focus:border-transparent transition mb-5">
                
                <div class="flex justify-between gap-3">
                    <button id="cancelCategoryBtn" class="px-4 py-2 border border-gray-300 rounded-lg text-gray-700 hover:bg-gray-50 transition">Cancelar</button>
                    <div class="flex gap-3">
                        <button id="saveAndAddMoreCategoryBtn" class="px-4 py-2 bg-gray-200 text-gray-700 rounded-lg hover:bg-gray-300 transition shadow-md">
                            Salvar e Adicionar Outra
                        </button>
                        <button id="saveCategoryBtn" class="px-4 py-2 bg-primary text-white rounded-lg hover:bg-blue-700 transition shadow-md">Salvar</button>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Edit Name Modal -->
    <div id="editNameModal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4 z-50 hidden">
        <div class="bg-white rounded-xl shadow-xl w-full max-w-md modal-container slide-in">
            <div class="p-5 border-b border-gray-100">
                <h3 id="editModalTitle" class="text-lg font-semibold text-gray-900">Editar Nome</h3>
            </div>
            <div class="p-5">
                <label for="editNameInput" class="block text-sm font-medium text-gray-700 mb-2">Novo Nome</label>
                <input type="text" id="editNameInput" 
                       class="w-full px-4 py-2 border border-gray-200 rounded-lg focus:outline-none focus:ring-2 focus:ring-primary focus:border-transparent transition mb-5">
                <div class="flex justify-between gap-3">
                    <button id="cancelEditBtn" class="px-4 py-2 border border-gray-300 rounded-lg text-gray-700 hover:bg-gray-50 transition">Cancelar</button>
                    <button id="saveEditBtn" class="px-4 py-2 bg-primary text-white rounded-lg hover:bg-blue-700 transition shadow-md">Salvar</button>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Help Modal -->
    <div id="helpModal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4 z-50 hidden">
        <div class="bg-white rounded-xl shadow-xl w-full max-w-md modal-container slide-in">
            <div class="p-5 border-b border-gray-100 flex justify-between items-center">
                <h3 class="text-lg font-semibold text-gray-900">Ajuda</h3>
                <button id="closeHelpBtn" class="text-gray-400 hover:text-gray-600">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            <div class="p-5 max-h-[70vh] overflow-y-auto">
                <div class="mb-6">
                    <h4 class="font-medium text-gray-800 mb-2">Como usar:</h4>
                    <ol class="list-decimal list-inside space-y-2 text-gray-600 text-sm">
                        <li>Adicione o nome do evento</li>
                        <li>Crie distâncias (ex: 5km, 10km)</li>
                        <li>Para cada distância, adicione categorias (ex: Masculino 18-30)</li>
                        <li>Preencha os números e nomes dos atletas</li>
                        <li>Clique nas bolinhas para marcar os premiados</li>
                        <li>Exporte os resultados quando terminar</li>
                    </ol>
                </div>
                
                <div class="mb-6">
                    <h4 class="font-medium text-gray-800 mb-2">Dicas:</h4>
                    <ul class="list-disc list-inside space-y-2 text-gray-600 text-sm">
                        <li>Você pode importar dados de planilhas (CSV ou Excel)</li>
                        <li>Use o botão de cadeado para bloquear/desbloquear edições</li>
                        <li>Os dados são salvos automaticamente no seu navegador</li>
                        <li>Arraste as linhas para reorganizar, mantendo a ordem numérica</li>
                        <li>Clique no nome da distância ou categoria para editar</li>
                    </ul>
                </div>
                
                <div class="bg-blue-50 p-3 rounded-lg border border-blue-100">
                    <h4 class="font-medium text-blue-800 mb-1 flex items-center gap-2">
                        <i class="fas fa-info-circle"></i> Informação
                    </h4>
                    <p class="text-blue-700 text-sm">Este aplicativo funciona offline após carregado. Você pode instalá-lo como um app no seu celular.</p>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Detail Modal -->
    <div id="detailModal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4 z-50 hidden">
        <div class="bg-white rounded-xl shadow-xl w-full max-w-md detail-modal slide-in">
            <div class="p-5 border-b border-gray-100 flex justify-between items-center">
                <h3 class="text-lg font-semibold text-gray-900">Detalhes do Atleta</h3>
                <button id="closeDetailBtn" class="text-gray-400 hover:text-gray-600">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            <div class="p-5 detail-modal-content">
                <div class="grid grid-cols-2 gap-4">
                    <div>
                        <p class="text-sm text-gray-500">Número</p>
                        <p id="detailNumber" class="font-medium">-</p>
                    </div>
                    <div>
                        <p class="text-sm text-gray-500">Nome</p>
                        <div class="flex items-center gap-2">
                            <p id="detailName" class="font-medium">-</p>
                            <button id="copyNameBtn" class="text-primary hover:text-blue-700" title="Copiar nome">
                                <i class="fas fa-copy"></i>
                            </button>
                        </div>
                    </div>
                    <div>
                        <p class="text-sm text-gray-500">Equipe</p>
                        <p id="detailTeam" class="font-medium">-</p>
                    </div>
                    <div>
                        <p class="text-sm text-gray-500">Sexo</p>
                        <p id="detailGender" class="font-medium">-</p>
                    </div>
                    <div>
                        <p class="text-sm text-gray-500">Categoria</p>
                        <p id="detailCategory" class="font-medium">-</p>
                    </div>
                    <div>
                        <p class="text-sm text-gray-500">Modalidade</p>
                        <p id="detailModality" class="font-medium">-</p>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Pace Calculator Modal -->
    <div id="paceCalculatorModal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4 z-50 hidden">
        <div class="bg-white rounded-xl shadow-xl w-full max-w-md modal-container slide-in">
            <div class="p-5 border-b border-gray-100 flex justify-between items-center">
                <h3 class="text-lg font-semibold text-gray-900">Calculadora de Pace</h3>
                <button id="closePaceCalculatorBtn" class="text-gray-400 hover:text-gray-600">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            <div class="p-5">
                <div class="mb-4">
                    <label class="block text-sm font-medium text-gray-700 mb-2">Distâncias Padrão</label>
                    <div class="grid grid-cols-3 gap-2 mb-4">
                        <button class="distance-btn" data-distance="5">5km</button>
                        <button class="distance-btn" data-distance="10">10km</button>
                        <button class="distance-btn" data-distance="15">15km</button>
                        <button class="distance-btn" data-distance="21.0975">Meia Maratona</button>
                        <button class="distance-btn" data-distance="42.195">Maratona</button>
                        <button class="distance-btn" data-distance="custom">Personalizado</button>
                    </div>
                    
                    <label for="distanceInput" class="block text-sm font-medium text-gray-700 mb-2">Distância (km)</label>
                    <input type="number" id="distanceInput" min="0.1" step="0.1" placeholder="Ex: 5, 10, 21.1" 
                           class="w-full px-4 py-2 border border-gray-200 rounded-lg focus:outline-none focus:ring-2 focus:ring-primary focus:border-transparent transition">
                </div>
                
                <div class="mb-4">
                    <label class="block text-sm font-medium text-gray-700 mb-2">Tempo Total</label>
                    <div class="time-input-container">
                        <input type="number" id="hoursInput" min="0" max="23" placeholder="HH" 
                               class="time-input px-3 py-2 border border-gray-200 rounded-lg focus:outline-none focus:ring-1 focus:ring-primary focus:border-transparent transition">
                        <span class="time-separator">:</span>
                        <input type="number" id="minutesInput" min="0" max="59" placeholder="MM" 
                               class="time-input px-3 py-2 border border-gray-200 rounded-lg focus:outline-none focus:ring-1 focus:ring-primary focus:border-transparent transition">
                        <span class="time-separator">:</span>
                        <input type="number" id="secondsInput" min="0" max="59" placeholder="SS" 
                               class="time-input px-3 py-2 border border-gray-200 rounded-lg focus:outline-none focus:ring-1 focus:ring-primary focus:border-transparent transition">
                    </div>
                </div>
                
                <div class="mb-6">
                    <button id="calculatePaceBtn" class="w-full bg-primary hover:bg-blue-700 text-white py-2 px-4 rounded-lg transition flex items-center justify-center gap-2 shadow-md">
                        <i class="fas fa-calculator"></i> Calcular
                    </button>
                </div>
                
                <div id="paceResults" class="hidden">
                    <div class="bg-gray-50 p-4 rounded-lg border border-gray-200 mb-4">
                        <h4 class="font-medium text-gray-800 mb-2 text-center">Resultados</h4>
                        <div class="grid grid-cols-2 gap-4">
                            <div class="bg-white p-3 rounded-lg border border-gray-200 text-center">
                                <p class="text-sm text-gray-500">Pace Médio</p>
                                <p id="paceResult" class="text-xl font-bold text-primary">-</p>
                                <p class="text-xs text-gray-500">min/km</p>
                            </div>
                            <div class="bg-white p-3 rounded-lg border border-gray-200 text-center">
                                <p class="text-sm text-gray-500">Velocidade Média</p>
                                <p id="speedResult" class="text-xl font-bold text-primary">-</p>
                                <p class="text-xs text-gray-500">km/h</p>
                            </div>
                        </div>
                    </div>
                </div>
                
                <div class="flex justify-between gap-3">
                    <button id="clearPaceCalculatorBtn" class="px-4 py-2 bg-gray-200 text-gray-700 rounded-lg hover:bg-gray-300 transition shadow-md flex items-center gap-2">
                        <i class="fas fa-trash-alt"></i> Limpar
                    </button>
                    <button id="closePaceCalculatorBtn2" class="px-4 py-2 bg-primary text-white rounded-lg hover:bg-blue-700 transition shadow-md">Fechar</button>
                </div>
            </div>
        </div>
    </div>
    
    <script>
        // Manifest for PWA
        const manifest = {
            "name": "Controle de Chegada",
            "short_name": "Chegada",
            "start_url": ".",
            "display": "standalone",
            "background_color": "#3b82f6",
            "description": "Aplicativo para controle de chegada em corridas",
            "icons": [
                {
                    "src": "icon.png",
                    "sizes": "192x192",
                    "type": "image/png"
                },
                {
                    "src": "icon.png",
                    "sizes": "512x512",
                    "type": "image/png"
                }
            ],
            "orientation": "portrait"
        };
        
        // Create manifest file dynamically
        const blob = new Blob([JSON.stringify(manifest)], {type: 'application/json'});
        const manifestURL = URL.createObjectURL(blob);
        document.querySelector('link[rel="manifest"]').href = manifestURL;
        
        document.addEventListener('DOMContentLoaded', function() {
            // DOM Elements
            const eventNameInput = document.getElementById('eventName');
            const addDistanceBtn = document.getElementById('addDistanceBtn');
            const addFirstDistanceBtn = document.getElementById('addFirstDistanceBtn');
            const clearAllBtn = document.getElementById('clearAllBtn');
            const lockBtn = document.getElementById('lockBtn');
            const helpBtn = document.getElementById('helpBtn');
            const closeHelpBtn = document.getElementById('closeHelpBtn');
            const distancesContainer = document.getElementById('distancesContainer');
            const emptyState = document.getElementById('emptyState');
            const distanceModal = document.getElementById('distanceModal');
            const categoryModal = document.getElementById('categoryModal');
            const editNameModal = document.getElementById('editNameModal');
            const helpModal = document.getElementById('helpModal');
            const detailModal = document.getElementById('detailModal');
            const closeDetailBtn = document.getElementById('closeDetailBtn');
            const searchInput = document.getElementById('searchInput');
            const clearSearchBtn = document.getElementById('clearSearchBtn');
            const importBtn = document.getElementById('importBtn');
            const exportBtn = document.getElementById('exportBtn');
            const importFile = document.getElementById('importFile');
            const importResults = document.getElementById('importResults');
            const copyNameBtn = document.getElementById('copyNameBtn');
            const paceCalculatorBtn = document.getElementById('paceCalculatorBtn');
            const paceCalculatorModal = document.getElementById('paceCalculatorModal');
            const closePaceCalculatorBtn = document.getElementById('closePaceCalculatorBtn');
            const closePaceCalculatorBtn2 = document.getElementById('closePaceCalculatorBtn2');
            const clearPaceCalculatorBtn = document.getElementById('clearPaceCalculatorBtn');
            const calculatePaceBtn = document.getElementById('calculatePaceBtn');
            const distanceInput = document.getElementById('distanceInput');
            const hoursInput = document.getElementById('hoursInput');
            const minutesInput = document.getElementById('minutesInput');
            const secondsInput = document.getElementById('secondsInput');
            const paceResults = document.getElementById('paceResults');
            const paceResult = document.getElementById('paceResult');
            const speedResult = document.getElementById('speedResult');
            
            // Edit modal elements
            const editModalTitle = document.getElementById('editModalTitle');
            const editNameInput = document.getElementById('editNameInput');
            const cancelEditBtn = document.getElementById('cancelEditBtn');
            const saveEditBtn = document.getElementById('saveEditBtn');
            
            // New buttons for multiple additions
            const saveAndAddMoreDistanceBtn = document.getElementById('saveAndAddMoreDistanceBtn');
            const saveAndAddMoreCategoryBtn = document.getElementById('saveAndAddMoreCategoryBtn');
            
            // Detail modal elements
            const detailNumber = document.getElementById('detailNumber');
            const detailName = document.getElementById('detailName');
            const detailTeam = document.getElementById('detailTeam');
            const detailGender = document.getElementById('detailGender');
            const detailCategory = document.getElementById('detailCategory');
            const detailModality = document.getElementById('detailModality');
            
            // Distance buttons in pace calculator
            const distanceButtons = document.querySelectorAll('.distance-btn');
            
            // State
            let isLocked = false;
            let currentDistanceId = null;
            let currentEditElement = null;
            let currentEditType = null; // 'distance' or 'category'
            let importedData = [];
            let draggedItem = null;
            let selectedAthlete = null;
            
            // Initialize
            checkEmptyState();
            loadFromLocalStorage();
            
            // Event Listeners
            addDistanceBtn.addEventListener('click', showDistanceModal);
            addFirstDistanceBtn.addEventListener('click', showDistanceModal);
            clearAllBtn.addEventListener('click', clearAll);
            lockBtn.addEventListener('click', toggleLock);
            helpBtn.addEventListener('click', () => helpModal.classList.remove('hidden'));
            closeHelpBtn.addEventListener('click', () => helpModal.classList.add('hidden'));
            closeDetailBtn.addEventListener('click', () => detailModal.classList.add('hidden'));
            importBtn.addEventListener('click', () => importFile.click());
            exportBtn.addEventListener('click', exportData);
            importFile.addEventListener('change', handleFileImport);
            searchInput.addEventListener('input', handleSearch);
            clearSearchBtn.addEventListener('click', clearSearch);
            copyNameBtn.addEventListener('click', copyAthleteName);
            paceCalculatorBtn.addEventListener('click', () => paceCalculatorModal.classList.remove('hidden'));
            closePaceCalculatorBtn.addEventListener('click', () => paceCalculatorModal.classList.add('hidden'));
            closePaceCalculatorBtn2.addEventListener('click', () => paceCalculatorModal.classList.add('hidden'));
            clearPaceCalculatorBtn.addEventListener('click', clearPaceCalculator);
            calculatePaceBtn.addEventListener('click', calculatePace);
            
            // Distance buttons event listeners
            distanceButtons.forEach(button => {
                button.addEventListener('click', function() {
                    // Remove active class from all buttons
                    distanceButtons.forEach(btn => btn.classList.remove('active'));
                    
                    // Add active class to clicked button
                    this.classList.add('active');
                    
                    const distance = this.getAttribute('data-distance');
                    if (distance === 'custom') {
                        distanceInput.value = '';
                        distanceInput.focus();
                    } else {
                        distanceInput.value = distance;
                    }
                });
            });
            
            // Edit modal events
            cancelEditBtn.addEventListener('click', () => editNameModal.classList.add('hidden'));
            saveEditBtn.addEventListener('click', saveEditedName);
            
            // New event listeners for multiple additions
            saveAndAddMoreDistanceBtn.addEventListener('click', () => {
                saveDistance(false); // false = don't close modal
            });
            
            saveAndAddMoreCategoryBtn.addEventListener('click', () => {
                saveCategory(false); // false = don't close modal
            });
            
            // Save data when leaving the page
            window.addEventListener('beforeunload', saveToLocalStorage);
            
            // Distance Modal
            document.getElementById('cancelDistanceBtn').addEventListener('click', hideDistanceModal);
            document.getElementById('saveDistanceBtn').addEventListener('click', () => {
                saveDistance(true); // true = close modal
            });
            
            // Category Modal
            document.getElementById('cancelCategoryBtn').addEventListener('click', hideCategoryModal);
            document.getElementById('saveCategoryBtn').addEventListener('click', () => {
                saveCategory(true); // true = close modal
            });
            
            // Functions
            function showDistanceModal() {
                document.getElementById('distanceName').value = '';
                distanceModal.classList.remove('hidden');
                document.getElementById('distanceName').focus();
            }
            
            function hideDistanceModal() {
                distanceModal.classList.add('hidden');
            }
            
            function showCategoryModal(distanceId) {
                currentDistanceId = distanceId;
                document.getElementById('categoryName').value = '';
                document.getElementById('winnersCount').value = 3;
                categoryModal.classList.remove('hidden');
                document.getElementById('categoryName').focus();
            }
            
            function hideCategoryModal() {
                categoryModal.classList.add('hidden');
            }
            
            function showEditModal(type, currentName, element) {
                currentEditType = type;
                currentEditElement = element;
                
                if (type === 'distance') {
                    editModalTitle.textContent = 'Editar Nome da Distância';
                } else {
                    editModalTitle.textContent = 'Editar Nome da Categoria';
                }
                
                editNameInput.value = currentName;
                editNameModal.classList.remove('hidden');
                editNameInput.focus();
            }
            
            function saveEditedName() {
                const newName = editNameInput.value.trim();
                if (newName) {
                    if (currentEditType === 'distance') {
                        // Update distance name
                        const titleElement = currentEditElement.querySelector('h2');
                        titleElement.textContent = newName;
                    } else {
                        // Update category name
                        const titleElement = currentEditElement.querySelector('h3');
                        titleElement.textContent = newName;
                    }
                    
                    editNameModal.classList.add('hidden');
                    saveToLocalStorage();
                    showToast('Nome atualizado com sucesso!', 'success');
                } else {
                    showToast('Por favor, insira um nome válido', 'error');
                }
            }
            
            function saveDistance(closeModal = true) {
                const name = document.getElementById('distanceName').value.trim();
                if (name) {
                    createDistanceBlock(name);
                    
                    if (closeModal) {
                        hideDistanceModal();
                    } else {
                        // Clear the input for next entry
                        document.getElementById('distanceName').value = '';
                        document.getElementById('distanceName').focus();
                    }
                    
                    checkEmptyState();
                    saveToLocalStorage();
                    
                    // Show success feedback
                    showToast('Distância adicionada com sucesso!', 'success');
                } else {
                    showToast('Por favor, insira um nome para da distância', 'error');
                }
            }
            
            function saveCategory(closeModal = true) {
                const name = document.getElementById('categoryName').value.trim();
                const winnersCount = parseInt(document.getElementById('winnersCount').value);
                
                if (name && winnersCount > 0) {
                    createCategoryBlock(currentDistanceId, name, winnersCount);
                    
                    if (closeModal) {
                        hideCategoryModal();
                    } else {
                        // Clear the inputs for next entry
                        document.getElementById('categoryName').value = '';
                        document.getElementById('winnersCount').value = 3;
                        document.getElementById('categoryName').focus();
                    }
                    
                    saveToLocalStorage();
                    
                    // Show success feedback
                    showToast('Categoria adicionada com sucesso!', 'success');
                } else {
                    showToast('Por favor, preencha todos os campos corretamente', 'error');
                }
            }
            
            function createDistanceBlock(name) {
                const distanceId = 'distance-' + Date.now();
                
                const distanceBlock = document.createElement('div');
                distanceBlock.id = distanceId;
                distanceBlock.className = 'bg-white rounded-xl shadow-md border border-gray-100 overflow-hidden fade-in';
                
                distanceBlock.innerHTML = `
                    <div class="p-4 border-b border-gray-100 flex justify-between items-center bg-gray-50">
                        <div class="cursor-pointer hover:bg-gray-100 px-2 py-1 rounded transition" data-distance="${distanceId}">
                            <h2 class="font-semibold text-gray-800 responsive-text">${name}</h2>
                            <p class="text-xs text-gray-500 mt-1">Distância</p>
                        </div>
                        <div class="flex space-x-2">
                            <button class="add-category-btn p-2 text-primary hover:bg-blue-50 rounded-lg transition" data-distance="${distanceId}" title="Adicionar categoria">
                                <i class="fas fa-plus-circle"></i>
                            </button>
                            <button class="delete-distance-btn p-2 text-danger hover:bg-red-50 rounded-lg transition" data-distance="${distanceId}" title="Remover distância">
                                <i class="fas fa-trash-alt"></i>
                            </button>
                        </div>
                    </div>
                    <div class="categories-container p-3 space-y-3"></div>
                `;
                
                distancesContainer.appendChild(distanceBlock);
                
                // Add event listeners to the new buttons
                distanceBlock.querySelector('.add-category-btn').addEventListener('click', function() {
                    if (!isLocked) showCategoryModal(distanceId);
                });
                
                distanceBlock.querySelector('.delete-distance-btn').addEventListener('click', function() {
                    if (!isLocked) {
                        if (confirm('Tem certeza que deseja excluir esta distância e todas as suas categorias?')) {
                            distanceBlock.classList.add('opacity-0', 'h-0', 'overflow-hidden', 'transition-all', 'duration-300');
                            setTimeout(() => {
                                distanceBlock.remove();
                                checkEmptyState();
                                saveToLocalStorage();
                            }, 300);
                        }
                    }
                });
                
                // Add click event to edit distance name
                const titleContainer = distanceBlock.querySelector('div[data-distance]');
                titleContainer.addEventListener('click', function(e) {
                    if (!isLocked && e.target.tagName !== 'BUTTON') {
                        const currentName = distanceBlock.querySelector('h2').textContent;
                        showEditModal('distance', currentName, distanceBlock);
                    }
                });
                
                return distanceBlock;
            }
            
            function createCategoryBlock(distanceId, name, winnersCount) {
                const distanceBlock = document.getElementById(distanceId);
                if (!distanceBlock) return;
                
                const categoryId = 'category-' + Date.now();
                const categoriesContainer = distanceBlock.querySelector('.categories-container');
                
                const categoryBlock = document.createElement('div');
                categoryBlock.id = categoryId;
                categoryBlock.className = 'bg-gray-50 rounded-lg p-3 border border-gray-200 fade-in';
                
                categoryBlock.innerHTML = `
                    <div class="flex justify-between items-center mb-3">
                        <div class="cursor-pointer hover:bg-gray-100 px-2 py-1 rounded transition" data-category="${categoryId}">
                            <h3 class="font-medium text-gray-700 responsive-text">${name}</h3>
                            <p class="text-xs text-gray-500 mt-1">Categoria</p>
                        </div>
                        <button class="delete-category-btn p-2 text-danger hover:bg-red-50 rounded-lg transition" data-category="${categoryId}" title="Remover categoria">
                            <i class="fas fa-trash-alt"></i>
                            </button>
                    </div>
                    <div class="winners-container space-y-2"></div>
                `;
                
                categoriesContainer.appendChild(categoryBlock);
                
                // Add event listener to delete button
                categoryBlock.querySelector('.delete-category-btn').addEventListener('click', function() {
                    if (!isLocked) {
                        if (confirm('Tem certeza que deseja excluir esta categoria?')) {
                            categoryBlock.classList.add('opacity-0', 'h-0', 'overflow-hidden', 'transition-all', 'duration-300');
                            setTimeout(() => {
                                categoryBlock.remove();
                                saveToLocalStorage();
                            }, 300);
                        }
                    }
                });
                
                // Add click event to edit category name
                const titleContainer = categoryBlock.querySelector('div[data-category]');
                titleContainer.addEventListener('click', function(e) {
                    if (!isLocked && e.target.tagName !== 'BUTTON') {
                        const currentName = categoryBlock.querySelector('h3').textContent;
                        showEditModal('category', currentName, categoryBlock);
                    }
                });
                
                // Create winners
                const winnersContainer = categoryBlock.querySelector('.winners-container');
                for (let i = 1; i <= winnersCount; i++) {
                    createWinnerRow(winnersContainer, i);
                }
                
                // Initialize drag and drop for this category
                setupDragAndDrop(winnersContainer);
                
                return categoryBlock;
            }
            
            function createWinnerRow(container, position) {
                const row = document.createElement('div');
                row.className = 'winner-row fade-in';
                row.draggable = true;
                
                row.innerHTML = `
                    <div class="number-bubble rounded-full bg-red-500 text-white flex items-center justify-center cursor-pointer hover:opacity-90 transition" data-position="${position}">
                        ${position}
                    </div>
                    <input type="text" inputmode="numeric" pattern="[0-9]*" placeholder="Número" maxlength="6" class="number-input px-3 py-2 border border-gray-200 rounded-lg focus:outline-none focus:ring-1 focus:ring-primary focus:border-transparent transition input-field">
                    <input type="text" placeholder="Nome" maxlength="30" class="name-input px-3 py-2 border border-gray-200 rounded-lg focus:outline-none focus:ring-1 focus:ring-primary focus:border-transparent transition input-field">
                `;
                
                container.appendChild(row);
                
                // Add click event to number bubble
                const bubble = row.querySelector('.number-bubble');
                bubble.addEventListener('click', function() {
                    if (bubble.classList.contains('bg-red-500')) {
                        bubble.classList.remove('bg-red-500');
                        bubble.classList.add('bg-green-500');
                    } else {
                        bubble.classList.remove('bg-green-500');
                        bubble.classList.add('bg-red-500');
                    }
                    saveToLocalStorage();
                });
                
                // Add input change events
                const numberInput = row.querySelector('.number-input');
                numberInput.addEventListener('change', saveToLocalStorage);
                numberInput.addEventListener('input', function() {
                    // Allow only numbers and limit to 6 characters
                    this.value = this.value.replace(/[^0-9]/g, '').slice(0, 6);
                });
                
                const nameInput = row.querySelector('.name-input');
                nameInput.addEventListener('change', saveToLocalStorage);
                nameInput.addEventListener('input', function() {
                    this.value = this.value.toUpperCase();
                });
                
                return row;
            }
            
            function setupDragAndDrop(container) {
                const rows = container.querySelectorAll('.winner-row');
                
                rows.forEach(row => {
                    row.addEventListener('dragstart', function(e) {
                        if (isLocked) {
                            e.preventDefault();
                            return;
                        }
                        draggedItem = row;
                        setTimeout(() => {
                            row.classList.add('dragging');
                        }, 0);
                    });
                    
                    row.addEventListener('dragend', function() {
                        row.classList.remove('dragging');
                        draggedItem = null;
                    });
                    
                    row.addEventListener('dragover', function(e) {
                        e.preventDefault();
                        if (!draggedItem || isLocked) return;
                        
                        // Highlight drop target
                        this.classList.add('drop-target');
                    });
                    
                    row.addEventListener('dragleave', function() {
                        this.classList.remove('drop-target');
                    });
                    
                    row.addEventListener('drop', function(e) {
                        e.preventDefault();
                        this.classList.remove('drop-target');
                        
                        if (!draggedItem || draggedItem === this || isLocked) return;
                        
                        // Get the container element
                        const container = this.parentNode;
                        
                        // Get references to the dragged item and target item
                        const draggedIndex = Array.from(container.children).indexOf(draggedItem);
                        const targetIndex = Array.from(container.children).indexOf(this);
                        
                        // Move the dragged item to the target position
                        if (draggedIndex < targetIndex) {
                            container.insertBefore(draggedItem, this.nextSibling);
                        } else {
                            container.insertBefore(draggedItem, this);
                        }
                        
                        // Update the bubble numbers to maintain the sequence
                        updateBubbleNumbers(container);
                        
                        saveToLocalStorage();
                    });
                });
            }
            
            function updateBubbleNumbers(container) {
                const rows = container.querySelectorAll('.winner-row');
                rows.forEach((row, index) => {
                    const position = index + 1;
                    const bubble = row.querySelector('.number-bubble');
                    bubble.textContent = position;
                    bubble.setAttribute('data-position', position);
                });
            }
            
            function clearAll() {
                if (!isLocked && confirm('Tem certeza que deseja limpar todos os dados? Isso não pode ser desfeito.')) {
                    // Animate out all distances
                    const distances = Array.from(distancesContainer.children);
                    distances.forEach(distance => {
                        distance.classList.add('opacity-0', 'h-0', 'overflow-hidden', 'transition-all', 'duration-300');
                    });
                    
                    setTimeout(() => {
                        distancesContainer.innerHTML = '';
                        eventNameInput.value = '';
                        checkEmptyState();
                        clearImportedData();
                        localStorage.clear();
                        
                        // Show feedback
                        showToast('Todos os dados foram removidos', 'info');
                    }, 300);
                }
            }
            
            function toggleLock() {
                isLocked = !isLocked;
                
                if (isLocked) {
                    lockBtn.innerHTML = '<i class="fas fa-lock-open"></i>';
                    lockBtn.title = "Desbloquear edição";
                    document.body.classList.add('locked');
                    showToast('Edição bloqueada', 'info');
                } else {
                    lockBtn.innerHTML = '<i class="fas fa-lock"></i>';
                    lockBtn.title = "Bloquear edição";
                    document.body.classList.remove('locked');
                    showToast('Edição desbloqueada', 'info');
                }
            }
            
            function checkEmptyState() {
                if (distancesContainer.children.length === 0) {
                    emptyState.classList.remove('hidden');
                } else {
                    emptyState.classList.add('hidden');
                }
            }
            
            function handleFileImport(e) {
                const file = e.target.files[0];
                if (!file) return;
                
                const reader = new FileReader();
                reader.onload = function(e) {
                    try {
                        let data;
                        if (file.name.endsWith('.xlsx')) {
                            const workbook = XLSX.read(e.target.result, {type: 'binary'});
                            const firstSheet = workbook.Sheets[workbook.SheetNames[0]];
                            data = XLSX.utils.sheet_to_json(firstSheet, {defval: ''});
                            
                            // Mapear colunas para nomes padrão, mantendo os dados originais
                            if (data && data.length > 0) {
                                data = data.map(row => {
                                    const newRow = {};
                                    for (const key in row) {
                                        const lowerKey = key.toLowerCase();
                                        if (lowerKey.includes('número') || lowerKey.includes('numero')) {
                                            newRow.NUMERO = row[key];
                                        } else if (lowerKey.includes('nome')) {
                                            newRow.NOME = row[key];
                                        } else if (lowerKey.includes('equipe') || lowerKey.includes('time') || lowerKey.includes('clube')) {
                                            newRow.EQUIPE = row[key];
                                        } else if (lowerKey.includes('sexo') || lowerKey.includes('gênero') || lowerKey.includes('genero')) {
                                            newRow.SEXO = row[key];
                                        } else if (lowerKey.includes('categoria') || lowerKey.includes('faixa') || lowerKey.includes('idade') || lowerKey.includes('class')) {
                                            newRow.CATEGORIA = row[key];
                                        } else if (lowerKey.includes('modalidade') || lowerKey.includes('distância') || lowerKey.includes('distancia') || lowerKey.includes('prova') || lowerKey.includes('evento')) {
                                            newRow.MODALIDADE = row[key];
                                        } else {
                                            // Manter outras colunas como estão
                                            newRow[key] = row[key];
                                        }
                                    }
                                    return newRow;
                                });
                            }
                        } else if (file.name.endsWith('.csv')) {
                            data = parseCSV(e.target.result);
                        } else {
                            throw new Error('Formato de arquivo não suportado');
                        }
                        
                        importedData = Array.isArray(data) ? data : [data];
                        displayImportedData();
                        showToast(`Dados importados: ${importedData.length} registros`, 'success');
                    } catch (error) {
                        showToast('Erro ao importar dados: ' + error.message, 'error');
                    }
                };
                
                if (file.name.endsWith('.xlsx')) {
                    reader.readAsBinaryString(file);
                } else {
                    reader.readAsText(file);
                }
            }
            
            function parseCSV(csvText) {
                const lines = csvText.split('\n');
                const headers = lines[0].split(',').map(h => h.trim());
                const result = [];
                
                for (let i = 1; i < lines.length; i++) {
                    if (!lines[i].trim()) continue;
                    
                    const obj = {};
                    const currentLine = lines[i].split(',');
                    
                    for (let j = 0; j < headers.length; j++) {
                        obj[headers[j]] = currentLine[j] ? currentLine[j].trim() : '';
                    }
                    
                    result.push(obj);
                }
                
                return result;
            }
            
            function displayImportedData() {
                importResults.innerHTML = '';
                importResults.classList.remove('hidden');
                
                if (importedData.length === 0) {
                    importResults.innerHTML = '<p class="text-gray-500 p-3 text-center">Nenhum dado importado</p>';
                    return;
                }
                
                const tableContainer = document.createElement('div');
                tableContainer.className = 'table-container w-full';
                
                const table = document.createElement('div');
                table.className = 'w-full text-xs border border-gray-200 rounded-lg overflow-hidden';
                table.style.minWidth = '600px'; // Ensure enough space for all columns
                
                // Header
                const headerRow = document.createElement('div');
                headerRow.className = 'flex bg-gray-100 font-medium border-b border-gray-200';
                headerRow.innerHTML = `
                    <div class="p-2 w-1/6 border-r border-gray-200">Número</div>
                    <div class="p-2 w-2/6 border-r border-gray-200">Nome</div>
                    <div class="p-2 w-1/6 border-r border-gray-200">Equipe</div>
                    <div class="p-2 w-1/6 border-r border-gray-200">Sexo</div>
                    <div class="p-2 w-1/6 border-r border-gray-200">Categoria</div>
                    <div class="p-2 w-1/6">Modalidade</div>
                `;
                table.appendChild(headerRow);
                
                // Rows
                importedData.forEach((item, index) => {
                    const row = document.createElement('div');
                    row.className = 'flex border-b border-gray-200 hover:bg-gray-50 cursor-pointer';
                    row.innerHTML = `
                        <div class="p-2 w-1/6 border-r border-gray-200">${item.NUMERO || item.numero || ''}</div>
                        <div class="p-2 w-2/6 border-r border-gray-200">${item.NOME || item.nome || ''}</div>
                        <div class="p-2 w-1/6 border-r border-gray-200">${item.EQUIPE || item.equipe || ''}</div>
                        <div class="p-2 w-1/6 border-r border-gray-200">${item.SEXO || item.sexo || ''}</div>
                        <div class="p-2 w-1/6 border-r border-gray-200">${item.CATEGORIA || item.categoria || ''}</div>
                        <div class="p-2 w-1/6">${item.MODALIDADE || item.modalidade || ''}</div>
                    `;
                    
                    // Add click event to show details
                    row.addEventListener('click', function() {
                        showAthleteDetails(item);
                    });
                    
                    table.appendChild(row);
                });
                
                tableContainer.appendChild(table);
                importResults.appendChild(tableContainer);
            }
            
            function showAthleteDetails(athlete) {
                selectedAthlete = athlete;
                
                // Set details in modal
                detailNumber.textContent = athlete.NUMERO || athlete.numero || '-';
                detailName.textContent = athlete.NOME || athlete.nome || '-';
                detailTeam.textContent = athlete.EQUIPE || athlete.equipe || '-';
                detailGender.textContent = athlete.SEXO || athlete.sexo || '-';
                detailCategory.textContent = athlete.CATEGORIA || athlete.categoria || '-';
                detailModality.textContent = athlete.MODALIDADE || athlete.modalidade || '-';
                
                // Show modal
                detailModal.classList.remove('hidden');
            }
            
            function copyAthleteName() {
                if (!selectedAthlete) return;
                
                const name = selectedAthlete.NOME || selectedAthlete.nome || '';
                if (name) {
                    navigator.clipboard.writeText(name)
                        .then(() => {
                            showToast('Nome copiado para a área de transferência!', 'success');
                        })
                        .catch(err => {
                            console.error('Failed to copy name: ', err);
                            showToast('Erro ao copiar nome', 'error');
                        });
                }
            }
            
            function findDistanceBlock(name) {
                const distances = Array.from(distancesContainer.children);
                return distances.find(distance => {
                    const title = distance.querySelector('h2').textContent;
                    return title.toLowerCase() === name.toLowerCase();
                });
            }
            
            function findCategoryBlock(distanceBlock, name) {
                const categories = Array.from(distanceBlock.querySelectorAll('.categories-container > div'));
                return categories.find(category => {
                    const title = category.querySelector('h3').textContent;
                    return title.toLowerCase() === name.toLowerCase();
                });
            }
            
            function clearImportedData() {
                importedData = [];
                importResults.innerHTML = '';
                importResults.classList.add('hidden');
                importFile.value = '';
            }
            
            function handleSearch() {
                const query = searchInput.value.toLowerCase();
                
                // Show/hide clear button
                if (query) {
                    clearSearchBtn.classList.remove('hidden');
                } else {
                    clearSearchBtn.classList.add('hidden');
                    importResults.classList.add('hidden');
                    return;
                }
                
                if (!importedData || importedData.length === 0) {
                    importResults.innerHTML = '<p class="text-gray-500 p-3 text-center">Nenhum dado importado para buscar</p>';
                    importResults.classList.remove('hidden');
                    return;
                }
                
                // Filter imported data
                const filtered = importedData.filter(item => {
                    const numero = String(item.NUMERO || item.numero || '').toLowerCase();
                    const nome = String(item.NOME || item.nome || '').toLowerCase();
                    return numero.includes(query) || nome.includes(query);
                });
                
                if (filtered.length > 0) {
                    importResults.innerHTML = '';
                    const tableContainer = document.createElement('div');
                    tableContainer.className = 'table-container w-full';
                    
                    const table = document.createElement('div');
                    table.className = 'w-full text-xs border border-gray-200 rounded-lg overflow-hidden';
                    table.style.minWidth = '600px';
                    
                    // Header
                    const headerRow = document.createElement('div');
                    headerRow.className = 'flex bg-gray-100 font-medium border-b border-gray-200';
                    headerRow.innerHTML = `
                        <div class="p-2 w-1/6 border-r border-gray-200">Número</div>
                        <div class="p-2 w-2/6 border-r border-gray-200">Nome</div>
                        <div class="p-2 w-1/6 border-r border-gray-200">Equipe</div>
                        <div class="p-2 w-1/6 border-r border-gray-200">Sexo</div>
                        <div class="p-2 w-1/6 border-r border-gray-200">Categoria</div>
                        <div class="p-2 w-1/6">Modalidade</div>
                    `;
                    table.appendChild(headerRow);
                    
                    // Rows
                    filtered.forEach((item, index) => {
                        const row = document.createElement('div');
                        row.className = 'flex border-b border-gray-200 hover:bg-gray-50 cursor-pointer';
                        row.innerHTML = `
                            <div class="p-2 w-1/6 border-r border-gray-200">${item.NUMERO || item.numero || ''}</div>
                            <div class="p-2 w-2/6 border-r border-gray-200">${item.NOME || item.nome || ''}</div>
                            <div class="p-2 w-1/6 border-r border-gray-200">${item.EQUIPE || item.equipe || ''}</div>
                            <div class="p-2 w-1/6 border-r border-gray-200">${item.SEXO || item.sexo || ''}</div>
                            <div class="p-2 w-1/6 border-r border-gray-200">${item.CATEGORIA || item.categoria || ''}</div>
                            <div class="p-2 w-1/6">${item.MODALIDADE || item.modalidade || ''}</div>
                        `;
                        
                        // Add click event to show details
                        row.addEventListener('click', function() {
                            showAthleteDetails(item);
                        });
                        
                        table.appendChild(row);
                    });
                    
                    tableContainer.appendChild(table);
                    importResults.innerHTML = '';
                    importResults.appendChild(tableContainer);
                    importResults.classList.remove('hidden');
                } else {
                    importResults.innerHTML = '<p class="text-gray-500 p-3 text-center">Nenhum resultado encontrado</p>';
                    importResults.classList.remove('hidden');
                }
            }
            
            function clearSearch() {
                searchInput.value = '';
                clearSearchBtn.classList.add('hidden');
                importResults.classList.add('hidden');
            }
            
            function exportData() {
                const eventName = eventNameInput.value.trim();
                let exportText = `Evento: ${eventName}\n`;
                exportText += `Data: ${new Date().toLocaleDateString()}\n\n`;
                
                // Get all distances
                const distances = Array.from(distancesContainer.children);
                
                if (distances.length === 0) {
                    showToast('Nenhum dado para exportar', 'warning');
                    return;
                }
                
                distances.forEach(distanceBlock => {
                    const distanceName = distanceBlock.querySelector('h2').textContent;
                    exportText += `=== ${distanceName} ===\n`;
                    
                    // Get all categories in this distance
                    const categories = Array.from(distanceBlock.querySelectorAll('.categories-container > div'));
                    
                    categories.forEach(categoryBlock => {
                        const categoryName = categoryBlock.querySelector('h3').textContent;
                        exportText += `\nCategoria: ${categoryName}\n`;
                        exportText += '--------------------------------\n';
                        
                        // Get all winners in this category
                        const winners = Array.from(categoryBlock.querySelectorAll('.winners-container > div'));
                        
                        winners.forEach(winnerRow => {
                            const position = winnerRow.querySelector('.number-bubble').textContent;
                            const isGreen = winnerRow.querySelector('.number-bubble').classList.contains('bg-green-500');
                            const number = winnerRow.querySelector('input[placeholder="Número"]').value;
                            const name = winnerRow.querySelector('input[placeholder="Nome"]').value;
                            
                            if (number || name) {
                                exportText += `${position}. ${number} - ${name}`;
                                if (isGreen) exportText += ' (PREMIADO)';
                                exportText += '\n';
                            }
                        });
                    });
                    
                    exportText += '\n';
                });
                
                // Create download link
                const blob = new Blob([exportText], {type: 'text/plain'});
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = `chegada_${eventName || 'evento'}_${new Date().toISOString().slice(0,10)}.txt`;
                document.body.appendChild(a);
                a.click();
                document.body.removeChild(a);
                URL.revokeObjectURL(url);
                
                // Show success feedback
                showToast('Dados exportados com sucesso!', 'success');
            }
            
            function saveToLocalStorage() {
                const data = {
                    eventName: eventNameInput.value,
                    distances: []
                };
                
                // Get all distances
                const distanceBlocks = Array.from(distancesContainer.children);
                
                distanceBlocks.forEach(distanceBlock => {
                    const distance = {
                        id: distanceBlock.id,
                        name: distanceBlock.querySelector('h2').textContent,
                        categories: []
                    };
                    
                    // Get all categories in this distance
                    const categoryBlocks = Array.from(distanceBlock.querySelectorAll('.categories-container > div'));
                    
                    categoryBlocks.forEach(categoryBlock => {
                        const category = {
                            id: categoryBlock.id,
                            name: categoryBlock.querySelector('h3').textContent,
                            winners: []
                        };
                        
                        // Get all winners in this category
                        const winnerRows = Array.from(categoryBlock.querySelectorAll('.winners-container > div'));
                        
                        winnerRows.forEach(winnerRow => {
                            const position = winnerRow.querySelector('.number-bubble').textContent;
                            const isGreen = winnerRow.querySelector('.number-bubble').classList.contains('bg-green-500');
                            const number = winnerRow.querySelector('input[placeholder="Número"]').value;
                            const name = winnerRow.querySelector('input[placeholder="Nome"]').value;
                            
                            category.winners.push({
                                position,
                                isGreen,
                                number,
                                name
                            });
                        });
                        
                        distance.categories.push(category);
                    });
                    
                    data.distances.push(distance);
                });
                
                localStorage.setItem('raceArrivalData', JSON.stringify(data));
            }
            
            function loadFromLocalStorage() {
                const savedData = localStorage.getItem('raceArrivalData');
                if (!savedData) return;
                
                try {
                    const data = JSON.parse(savedData);
                    
                    // Set event name
                    if (data.eventName) {
                        eventNameInput.value = data.eventName;
                    }
                    
                    // Recreate distances
                    if (data.distances && data.distances.length > 0) {
                        data.distances.forEach(distance => {
                            const distanceBlock = createDistanceBlock(distance.name);
                            distanceBlock.id = distance.id;
                            
                            // Recreate categories
                            if (distance.categories && distance.categories.length > 0) {
                                distance.categories.forEach(category => {
                                    const winnersCount = category.winners.length;
                                    const categoryBlock = createCategoryBlock(distance.id, category.name, winnersCount);
                                    categoryBlock.id = category.id;
                                    
                                    // Set winners data
                                    const winnerRows = categoryBlock.querySelectorAll('.winners-container > div');
                                    category.winners.forEach((winner, index) => {
                                        if (index < winnerRows.length) {
                                            const row = winnerRows[index];
                                            const bubble = row.querySelector('.number-bubble');
                                            const numberInput = row.querySelector('input[placeholder="Número"]');
                                            const nameInput = row.querySelector('input[placeholder="Nome"]');
                                            
                                            bubble.textContent = winner.position;
                                            if (winner.isGreen) {
                                                bubble.classList.remove('bg-red-500');
                                                bubble.classList.add('bg-green-500');
                                            }
                                            
                                            numberInput.value = winner.number || '';
                                            nameInput.value = winner.name || '';
                                        }
                                    });
                                });
                            }
                        });
                        
                        checkEmptyState();
                    }
                } catch (e) {
                    console.error('Error loading saved data:', e);
                }
            }
            
            function clearPaceCalculator() {
                distanceInput.value = '';
                hoursInput.value = '';
                minutesInput.value = '';
                secondsInput.value = '';
                paceResults.classList.add('hidden');
                
                // Remove active class from all distance buttons
                distanceButtons.forEach(btn => btn.classList.remove('active'));
            }
            
            function calculatePace() {
                const distance = parseFloat(distanceInput.value);
                const hours = parseInt(hoursInput.value) || 0;
                const minutes = parseInt(minutesInput.value) || 0;
                const seconds = parseInt(secondsInput.value) || 0;
                
                if (!distance || distance <= 0) {
                    showToast('Por favor, insira uma distância válida', 'error');
                    return;
                }
                
                if (hours === 0 && minutes === 0 && seconds === 0) {
                    showToast('Por favor, insira um tempo válido', 'error');
                    return;
                }
                
                // Calculate total time in seconds
                const totalSeconds = (hours * 3600) + (minutes * 60) + seconds;
                
                // Calculate pace (seconds per km)
                const paceSecondsPerKm = totalSeconds / distance;
                
                // Convert to minutes and seconds
                const paceMinutes = Math.floor(paceSecondsPerKm / 60);
                const paceSeconds = Math.round(paceSecondsPerKm % 60);
                
                // Format pace as MM:SS
                const formattedPace = `${paceMinutes}:${paceSeconds.toString().padStart(2, '0')}`;
                
                // Calculate average speed (km/h)
                const speedKmh = (distance / totalSeconds) * 3600;
                const formattedSpeed = speedKmh.toFixed(2);
                
                // Display results
                paceResult.textContent = formattedPace;
                speedResult.textContent = formattedSpeed;
                paceResults.classList.remove('hidden');
                
                // Scroll to results
                paceResults.scrollIntoView({ behavior: 'smooth', block: 'nearest' });
            }
            
            function showToast(message, type = 'info') {
                const toast = document.createElement('div');
                toast.className = `fixed bottom-4 right-4 px-4 py-2 rounded-lg shadow-lg text-white font-medium text-sm flex items-center gap-2 z-50 fade-in`;
                
                // Set color based on type
                switch(type) {
                    case 'success':
                        toast.className += ' bg-green-500';
                        toast.innerHTML = `<i class="fas fa-check-circle"></i> ${message}`;
                        break;
                    case 'error':
                        toast.className += ' bg-red-500';
                        toast.innerHTML = `<i class="fas fa-exclamation-circle"></i> ${message}`;
                        break;
                    case 'warning':
                        toast.className += ' bg-yellow-500';
                        toast.innerHTML = `<i class="fas fa-exclamation-triangle"></i> ${message}`;
                        break;
                    default:
                        toast.className += ' bg-blue-500';
                        toast.innerHTML = `<i class="fas fa-info-circle"></i> ${message}`;
                }
                
                document.body.appendChild(toast);
                
                // Auto remove after 3 seconds
                setTimeout(() => {
                    toast.classList.add('opacity-0', 'transition-opacity', 'duration-300');
                    setTimeout(() => {
                        toast.remove();
                    }, 300);
                }, 3000);
            }
        });
    </script>
<p style="border-radius: 8px; text-align: center; font-size: 12px; color: #fff; margin-top: 16px;position: fixed; left: 8px; bottom: 8px; z-index: 10; background: rgba(0, 0, 0, 0.8); padding: 4px 8px;">Made with <img src="https://enzostvs-deepsite.hf.space/logo.svg" alt="DeepSite Logo" style="width: 16px; height: 16px; vertical-align: middle;display:inline-block;margin-right:3px;filter:brightness(0) invert(1);"><a href="https://enzostvs-deepsite.hf.space" style="color: #fff;text-decoration: underline;" target="_blank" >DeepSite</a> - 🧬 <a href="https://enzostvs-deepsite.hf.space?remix=leandropricoli/controle-de-chegada" style="color: #fff;text-decoration: underline;" target="_blank" >Remix</a></p></body>
</html>
