<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Controle de Chegada</title>
  <link rel="manifest" href="manifest.json">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="default">
  <style>
    body { font-family: Arial, sans-serif; margin: 10px; background: #fff; }
    h1 { font-size: 26px; }
    h2 { margin-top: 20px; font-size: 22px; }
    .block { border: 1px solid #ccc; padding: 10px; margin-bottom: 20px; border-radius: 8px; }
    .category { margin-top: 10px; padding: 10px; border: 1px dashed #aaa; border-radius: 8px; margin-bottom: 10px; }
    .row { display: flex; align-items: center; margin-bottom: 4px; }
    .position-button { width: 40px; height: 40px; margin-right: 10px; background-color: red; color: white; font-size: 16px; border: none; border-radius: 5px; }
    .position-button.active { background-color: green; }
    input[type="tel"], input[type="text"] {
      font-size: 16px; padding: 5px; margin-right: 5px; border: 1px solid #ccc; border-radius: 5px;
    }
    input.number-field { width: 80px; }
    input.name-field { width: 95%; margin-top: 2px; }
    input#event-name { width: 100%; font-size: 18px; padding: 8px; margin-bottom: 20px; }
    button.add { margin-top: 10px; padding: 8px 12px; font-size: 16px; }
    .small-btn { margin-left: 5px; padding: 5px 8px; font-size: 14px; }
    #exportedText { white-space: pre-wrap; margin-top: 20px; background: #f9f9f9; padding: 10px; border: 1px solid #ccc; border-radius: 5px; }
    #toggleDragBtn { background-color: #ccc; border: none; padding: 8px 12px; font-size: 16px; margin-top: 10px; }
    #toggleDragBtn.active { background-color: #007BFF; color: white; }
  </style>
</head>
<body>

<h1>Controle de Chegada</h1>
<input type="text" id="event-name" placeholder="Nome do Evento">

<button id="toggleDragBtn" onclick="toggleDrag()">Editar Classificação</button>
<button class="add" onclick="addBlock()">Adicionar Bloco</button>
<button class="add" onclick="clearAll()">Limpar Tudo</button>
<button class="add" onclick="exportResults()">Exportar Resultados</button>

<div id="blocks"></div>
<div id="exportedText"></div>

<script src="https://cdn.jsdelivr.net/npm/sortablejs@1.15.0/Sortable.min.js"></script>

<script>
// Código JavaScript completo aqui
let blocks = [];
let dragEnabled = false;
let sortables = [];

function saveInputsToBlocks() {
  document.querySelectorAll('.block').forEach((blockEl, blockIndex) => {
    const block = blocks[blockIndex];
    if (block) {
      block.name = blockEl.querySelector('h2')?.textContent || block.name;
      block.categories.forEach((cat, catIndex) => {
        const catEl = blockEl.querySelectorAll('.category')[catIndex];
        if (catEl) {
          cat.name = catEl.querySelector('h3')?.textContent || cat.name;
          const rows = catEl.querySelectorAll('.row');
          cat.entries = [];
          rows.forEach((row) => {
            const number = row.querySelector('.number-field')?.value || '';
            const name = row.querySelector('.name-field')?.value || '';
            cat.entries.push({ number, name });
          });
        }
      });
    }
  });
}

function saveData() {
  saveInputsToBlocks();
  const eventName = document.getElementById('event-name').value;
  localStorage.setItem('blocksData', JSON.stringify(blocks));
  localStorage.setItem('eventName', eventName);
}

function loadData() {
  const saved = localStorage.getItem('blocksData');
  const eventName = localStorage.getItem('eventName');
  if (eventName) document.getElementById('event-name').value = eventName;
  if (saved) {
    blocks = JSON.parse(saved);
  } else {
    blocks = [];
    saveData();
  }
}

function clearAll() {
  if (confirm('Tem certeza que deseja limpar tudo?')) {
    blocks = [];
    localStorage.removeItem('blocksData');
    localStorage.removeItem('eventName');
    document.getElementById('event-name').value = '';
    renderBlocks();
  }
}

function createPositionRow(position, entry) {
  const wrapper = document.createElement('div');
  wrapper.className = 'row';

  const btn = document.createElement('button');
  btn.className = 'position-button';
  btn.textContent = position;
  btn.disabled = false;
  btn.onclick = () => btn.classList.toggle('active');

  const numInput = document.createElement('input');
  numInput.type = 'tel';
  numInput.inputMode = 'numeric';
  numInput.pattern = '[0-9]*';
  numInput.placeholder = 'Número';
  numInput.className = 'number-field';
  if (entry?.number) numInput.value = entry.number;

  const nameInput = document.createElement('input');
  nameInput.type = 'text';
  nameInput.placeholder = 'Nome do Atleta';
  nameInput.className = 'name-field';
  if (entry?.name) nameInput.value = entry.name;

  numInput.addEventListener('input', saveData);
  nameInput.addEventListener('input', saveData);

  wrapper.appendChild(btn);
  wrapper.appendChild(numInput);
  wrapper.appendChild(nameInput);

  return wrapper;
}

function createCategory(category, blockIndex, categoryIndex) {
  const div = document.createElement('div');
  div.className = 'category';

  const title = document.createElement('h3');
  title.contentEditable = true;
  title.textContent = category.name;
  title.addEventListener('input', saveData);

  const clearBtn = document.createElement('button');
  clearBtn.textContent = "Limpar";
  clearBtn.className = "small-btn";
  clearBtn.onclick = () => {
    div.querySelectorAll('.position-button').forEach(btn => btn.classList.remove('active'));
    div.querySelectorAll('input').forEach(input => input.value = '');
    saveData();
  };

  const setPositionsBtn = document.createElement('button');
  setPositionsBtn.textContent = "Quantidade de posições";
  setPositionsBtn.className = "small-btn";
  setPositionsBtn.onclick = () => {
    const newPos = prompt('Quantas posições para esta categoria?', category.positions);
    if (newPos && !isNaN(newPos)) {
      category.positions = parseInt(newPos);
      saveData();
      renderBlocks();
    }
  };

  const removeCategoryBtn = document.createElement('button');
  removeCategoryBtn.textContent = "Remover Categoria";
  removeCategoryBtn.className = "small-btn";
  removeCategoryBtn.onclick = () => {
    if (confirm('Tem certeza que deseja remover esta categoria?')) {
      blocks[blockIndex].categories.splice(categoryIndex, 1);
      saveData();
      renderBlocks();
    }
  };

  div.appendChild(title);
  div.appendChild(clearBtn);
  div.appendChild(setPositionsBtn);
  div.appendChild(removeCategoryBtn);

  const container = document.createElement('div');
  container.className = 'sortable';

  for (let i = 0; i < category.positions; i++) {
    container.appendChild(createPositionRow(i + 1, category.entries?.[i]));
  }

  div.appendChild(container);

  setTimeout(() => {
    const sortable = new Sortable(container, {
      animation: 150,
      disabled: !dragEnabled,
      onEnd: () => {
        updatePositions(container);
        saveData();
      }
    });
    sortables.push(sortable);
  }, 0);

  return div;
}

function updatePositions(container) {
  const rows = container.querySelectorAll('.row');
  rows.forEach((row, index) => {
    const button = row.querySelector('.position-button');
    button.textContent = index + 1;
  });
}

function toggleDrag() {
  dragEnabled = !dragEnabled;
  sortables.forEach(s => s.option('disabled', !dragEnabled));
  const btn = document.getElementById('toggleDragBtn');
  if (dragEnabled) {
    btn.classList.add('active');
  } else {
    btn.classList.remove('active');
  }
}

function renderBlocks() {
  const container = document.getElementById('blocks');
  container.innerHTML = '';
  sortables = [];

  blocks.forEach((block, blockIndex) => {
    const div = document.createElement('div');
    div.className = 'block';

    const blockTitle = document.createElement('h2');
    blockTitle.contentEditable = true;
    blockTitle.textContent = block.name;
    blockTitle.addEventListener('input', saveData);

    const addCategoryBtn = document.createElement('button');
    addCategoryBtn.textContent = "Adicionar Categoria";
    addCategoryBtn.className = "small-btn";
    addCategoryBtn.onclick = () => {
      const catName = prompt('Nome da nova categoria:');
      if (catName) {
        const positions = parseInt(prompt(`Quantas posições para a categoria "${catName}"?`));
        if (!isNaN(positions) && positions > 0) {
          blocks[blockIndex].categories.push({name: catName, positions: positions, entries: []});
          saveData();
          renderBlocks();
        }
      }
    };

    const removeBlockBtn = document.createElement('button');
    removeBlockBtn.textContent = "Remover Bloco";
    removeBlockBtn.className = "small-btn";
    removeBlockBtn.onclick = () => {
      if (confirm('Tem certeza que deseja remover este bloco?')) {
        blocks.splice(blockIndex, 1);
        saveData();
        renderBlocks();
      }
    };

    div.appendChild(blockTitle);
    div.appendChild(addCategoryBtn);
    div.appendChild(removeBlockBtn);

    block.categories.forEach((category, categoryIndex) => {
      div.appendChild(createCategory(category, blockIndex, categoryIndex));
    });

    container.appendChild(div);
  });
}

function addBlock() {
  const name = prompt('Nome do novo bloco:');
  if (!name) return;

  const numCategories = parseInt(prompt('Quantas categorias esse bloco terá?'));
  if (isNaN(numCategories) || numCategories <= 0) return;

  const categories = [];
  for (let i = 0; i < numCategories; i++) {
    const catName = prompt(`Nome da categoria ${i+1}:`);
    if (!catName) return;
    const positions = parseInt(prompt(`Quantas posições para a categoria "${catName}"?`));
    if (isNaN(positions) || positions <= 0) return;
    categories.push({name: catName, positions: positions, entries: []});
  }

  blocks.push({name: name, categories: categories});
  saveData();
  renderBlocks();
}

function exportResults() {
  let text = "";
  const eventName = document.getElementById('event-name').value;
  if (eventName) {
    text += `Evento: ${eventName}\n\n`;
  }
  blocks.forEach(block => {
    text += `Bloco: ${block.name}\n`;
    block.categories.forEach(cat => {
      text += `Categoria: ${cat.name}\n`;
      cat.entries?.forEach((entry, index) => {
        if (entry.number || entry.name) {
          text += `${index + 1}º - Número: ${entry.number} Nome: ${entry.name}\n`;
        }
      });
      text += "\n";
    });
  });
  const blob = new Blob([text], {type: "text/plain"});
  const link = document.createElement('a');
  link.href = URL.createObjectURL(blob);
  link.download = "resultados.txt";
  link.click();
  document.getElementById('exportedText').textContent = text;
}

// Inicializar
loadData();
renderBlocks();
</script>

</body>
</html>